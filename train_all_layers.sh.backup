#!/bin/bash
# Train Binary Probes Across All Layers (4-28)
# Assumes activations are already captured

set -e  # Exit on error

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Default configuration (optimized for small datasets)
ACTIVATIONS_DIR="./data/activations"
PROBES_DIR="./data/probes_binary"
LAYER_START=4
LAYER_END=28
PROBE_TYPE="linear"
BATCH_SIZE=16
EPOCHS=50
LR=0.0005
WEIGHT_DECAY=0.001
EARLY_STOPPING=10
DEVICE="auto"
USE_SCHEDULER=true

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --layer-start)
            LAYER_START="$2"
            shift 2
            ;;
        --layer-end)
            LAYER_END="$2"
            shift 2
            ;;
        --probe-type)
            PROBE_TYPE="$2"
            shift 2
            ;;
        --epochs)
            EPOCHS="$2"
            shift 2
            ;;
        --batch-size)
            BATCH_SIZE="$2"
            shift 2
            ;;
        --lr)
            LR="$2"
            shift 2
            ;;
        --weight-decay)
            WEIGHT_DECAY="$2"
            shift 2
            ;;
        --device)
            DEVICE="$2"
            shift 2
            ;;
        --no-scheduler)
            USE_SCHEDULER=false
            shift
            ;;
        --activations-dir)
            ACTIVATIONS_DIR="$2"
            shift 2
            ;;
        --output-dir)
            PROBES_DIR="$2"
            shift 2
            ;;
        --help)
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Train binary probes across all layers (assumes activations exist)"
            echo ""
            echo "Options:"
            echo "  --layer-start NUM        Start layer (default: 4)"
            echo "  --layer-end NUM          End layer (default: 28)"
            echo "  --probe-type TYPE        Probe type: linear or multihead (default: linear)"
            echo "  --epochs NUM             Max epochs with early stopping (default: 50)"
            echo "  --batch-size NUM         Batch size (default: 16)"
            echo "  --lr FLOAT               Learning rate (default: 0.0005)"
            echo "  --weight-decay FLOAT     Weight decay (default: 0.001)"
            echo "  --device DEVICE          Device: auto, cuda, or cpu (default: auto)"
            echo "  --no-scheduler           Disable learning rate scheduler"
            echo "  --activations-dir PATH   Activations directory (default: ./data/activations)"
            echo "  --output-dir PATH        Output directory (default: ./data/probes_binary)"
            echo "  --help                   Show this help message"
            echo ""
            echo "Examples:"
            echo "  # Train all layers with defaults"
            echo "  $0"
            echo ""
            echo "  # Quick test with fewer layers"
            echo "  $0 --layer-start 20 --layer-end 22 --epochs 10"
            echo ""
            echo "  # Custom configuration"
            echo "  $0 --batch-size 32 --epochs 30 --lr 0.001"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Print banner
echo -e "${BLUE}"
echo "==================================================================="
echo "  TRAIN BINARY PROBES ACROSS ALL LAYERS"
echo "  (Assumes activations already captured)"
echo "==================================================================="
echo -e "${NC}"

# Print configuration
NUM_LAYERS=$((LAYER_END - LAYER_START + 1))
TOTAL_PROBES=$((NUM_LAYERS * 45))

echo -e "${YELLOW}Configuration:${NC}"
echo "  Activations:  $ACTIVATIONS_DIR"
echo "  Output:       $PROBES_DIR"
echo "  Layers:       $LAYER_START-$LAYER_END ($NUM_LAYERS layers)"
echo "  Total Probes: $TOTAL_PROBES (45 per layer)"
echo "  Probe Type:   $PROBE_TYPE"
echo "  Epochs:       $EPOCHS (with early stopping)"
echo "  Batch Size:   $BATCH_SIZE"
echo "  Learning Rate: $LR"
echo "  Weight Decay:  $WEIGHT_DECAY"
echo "  Early Stopping: $EARLY_STOPPING epochs"
echo "  Scheduler:    $USE_SCHEDULER"
echo "  Device:       $DEVICE"
echo ""

# Check if activations exist
if [ ! -d "$ACTIVATIONS_DIR" ]; then
    echo -e "${RED}ERROR: Activations directory not found: $ACTIVATIONS_DIR${NC}"
    exit 1
fi

NUM_ACTIVATION_FILES=$(find "$ACTIVATIONS_DIR" -name "layer_*_activations.h5" | wc -l)
if [ $NUM_ACTIVATION_FILES -eq 0 ]; then
    echo -e "${RED}ERROR: No activation files found in $ACTIVATIONS_DIR${NC}"
    echo "Please run activation capture first."
    exit 1
fi

echo -e "${GREEN}âœ“ Found $NUM_ACTIVATION_FILES activation files${NC}"
echo ""

# Estimate time
EST_TIME_MIN=$((NUM_LAYERS * 25))
EST_TIME_HOURS=$((EST_TIME_MIN / 60))

echo -e "${YELLOW}Estimated time: $EST_TIME_HOURS-$((EST_TIME_HOURS + 2)) hours${NC}"
echo ""

# Confirm to proceed
read -p "Start training all layers? (y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 0
fi

# Change to probe directory
cd src/probes

# Build command
CMD="python train_all_layers.py \
    --activations-dir ../../$ACTIVATIONS_DIR \
    --output-dir ../../$PROBES_DIR \
    --layer-start $LAYER_START \
    --layer-end $LAYER_END \
    --probe-type $PROBE_TYPE \
    --batch-size $BATCH_SIZE \
    --epochs $EPOCHS \
    --lr $LR \
    --weight-decay $WEIGHT_DECAY \
    --early-stopping-patience $EARLY_STOPPING \
    --device $DEVICE"

if [ "$USE_SCHEDULER" = false ]; then
    CMD="$CMD --no-scheduler"
fi

# Run training
echo -e "\n${BLUE}Starting training...${NC}\n"

$CMD

if [ $? -eq 0 ]; then
    echo -e "\n${GREEN}âœ“ All layers training complete!${NC}"
else
    echo -e "\n${RED}âœ— Training failed!${NC}"
    exit 1
fi

# Display summary
cd ../..

SUMMARY_FILE="$PROBES_DIR/training_summary.json"
if [ -f "$SUMMARY_FILE" ]; then
    echo -e "\n${BLUE}Training Summary:${NC}"

    python3 << EOF
import json

with open("$SUMMARY_FILE", 'r') as f:
    summary = json.load(f)

stats = summary['statistics']
print(f"  Layers trained:   {summary['total_layers']}")
print(f"  Total probes:     {summary['total_probes']}")
print(f"  Total time:       {summary['total_time_hours']:.2f} hours")
print(f"\n  Average AUC-ROC:  {stats['avg_auc']:.4f}")
print(f"  Best AUC-ROC:     {stats['best_auc']:.4f} (Layer {stats['best_layer']})")
print(f"  Worst AUC-ROC:    {stats['worst_auc']:.4f}")
EOF

    echo ""
fi

echo -e "${YELLOW}Next Steps:${NC}"
echo "  1. Review summary: cat $PROBES_DIR/training_summary.json"
echo "  2. Test with best layer:"
echo "     cd src/probes"
echo "     python multi_probe_inference.py --probes-dir ../../$PROBES_DIR/layer_<best> --text 'Your text'"
echo ""

echo -e "${GREEN}All done! ðŸš€${NC}"